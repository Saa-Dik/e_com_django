{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile{% endblock %}

{% block content %}

<div class="min-h-screen bg-orange-50 py-10">
    <div class="max-w-5xl mx-auto px-4 space-y-6">

        <h1 class="text-3xl font-bold text-orange-600 text-center">My Profile</h1>

        <!-- =========================
             PROFILE HEADER
        ========================== -->
        <section class="bg-white rounded-xl shadow p-6 flex flex-col md:flex-row items-center gap-6">
            
            <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'images/default_profile.png' %}{% endif %}"
                 class="w-24 h-24 rounded-full object-cover border border-orange-300">

            <div class="flex-1 w-full">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">

                    <div>
                        <p class="text-xl font-semibold text-gray-900">
                            {{ user.first_name }} {{ user.last_name }}
                        </p>
                        <p class="text-sm text-gray-600">{{ user.email }}</p>
                        {% if user.phone_number %}
                        <p class="text-sm text-gray-600">{{ user.phone_number }}</p>
                        {% endif %}
                    </div>

                    <button onclick="document.getElementById('editProfileModal').classList.remove('hidden')"
                        class="px-4 py-2 rounded-lg bg-orange-600 text-white text-sm font-medium hover:bg-orange-700">
                        Edit Info
                    </button>
                </div>
            </div>
        </section>

        <!-- =========================
             TABS
        ========================== -->
        <section class="bg-white rounded-xl shadow p-6">

            <div class="border-b mb-4 flex gap-4 overflow-x-auto">
                <button class="tab-btn active-tab" data-tab="infoTab">Account Info</button>
                <button class="tab-btn" data-tab="addressTab">Addresses</button>
                <button class="tab-btn" data-tab="securityTab">Security</button>
            </div>

            <div>

                <!-- =========================
                     TAB 1: ACCOUNT INFO
                ========================== -->
                <div id="infoTab" class="tab-content">

                    <form method="POST" action="{% url 'profile' %}">
                        {% csrf_token %}
                        <input type="hidden" name="update_profile" value="1">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                            <div>
                                <label class="text-sm font-medium">First Name</label>
                                <input name="first_name" value="{{ user.first_name }}" class="input">
                            </div>

                            <div>
                                <label class="text-sm font-medium">Last Name</label>
                                <input name="last_name" value="{{ user.last_name }}" class="input">
                            </div>

                            <div>
                                <label class="text-sm font-medium">Email</label>
                                <input type="email" name="email" value="{{ user.email }}" class="input">
                            </div>

                            <div>
                                <label class="text-sm font-medium">Phone Number</label>
                                <input name="phone_number" value="{{ user.phone_number }}" class="input">
                            </div>

                        </div>

                        <button type="submit"
                            class="px-6 py-2 mt-4 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            Save Changes
                        </button>

                    </form>

                </div>

                <!-- =========================
                     TAB 2: ADDRESSES
                ========================== -->
                <div id="addressTab" class="tab-content hidden">

                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700">Saved Addresses</h2>
                        <button onclick="document.getElementById('addAddressModal').classList.remove('hidden')" 
                                class="px-4 py-2 bg-orange-600 text-white rounded-lg">
                            Add New Address
                        </button>
                    </div>

                    <div class="space-y-4">

                        {% if addresses %}
                        {% for addr in addresses %}
                        <div class="p-4 border rounded-lg shadow bg-white">

                            {% if addr.is_default %}
                                <span class="text-xs bg-orange-200 text-orange-700 px-2 py-1 rounded">
                                    Default Address
                                </span>
                            {% else %}
                                <a href="{% url 'set_default_address' addr.id %}"
                                   class="text-xs bg-gray-100 px-2 py-1 rounded ml-2">Set Default</a>
                            {% endif %}

                            <p class="font-semibold mt-1">{{ addr.full_name }}</p>
                            <p class="text-sm">Phone: {{ addr.phone }}</p>
                            <p class="text-sm">
                                {{ addr.address_line_1 }}
                                {% if addr.address_line_2 %}, {{ addr.address_line_2 }}{% endif %},
                                {{ addr.city }}, {{ addr.state }},
                                {{ addr.country }} - {{ addr.postal_code }}
                            </p>

                            <div class="flex gap-2 mt-3">
                              <button onclick = openEditAddressModal({{ add.id }}, '{{ addr.full_name }}','{{ addr.phone }}', '{{ addr.address_line_1 }}','{{ addr.address_line_2 }}', '{{ addr.city }}', '{{ addr.state }}', '{{ addr.postal_code }}', '{{ addr.country }}', {{ addr.is_default|yesno:"true,false" }})" )class="px-3 py-1 bg-gray-200 rounded text-xs">
                                Edit
                              </button>

                              <a href="{% url 'delete_address' addr.id %}" onclick="return confirm('Delete address?')" class="px-3 py-1 bg-red-300 rounded text-xs">
                                    Delete
                              </a>
                            </div>

                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-sm text-gray-500">No addresses saved yet.</p>
                        {% endif %}

                    </div>

                </div>

                <!-- =========================
                     TAB 3: SECURITY
                ========================== -->
                <div id="securityTab" class="tab-content hidden">
                    <p class="text-gray-600 text-sm">
                        Password reset is available using the "Forgot Password" option from login page.
                    </p>
                </div>

            </div>
        </section>

    </div>
</div>



<!-- ========================================================
     ADD ADDRESS MODAL
========================================================= -->
<div id="addAddressModal"
     class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">

    <div class="bg-white p-5 rounded-xl w-full max-w-lg shadow">

        <h2 class="text-lg font-semibold mb-3">Add New Address</h2>

        <form method="POST" action="{% url 'add_address' %}">
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

                <input name="full_name" placeholder="Full Name" class="input" required>
                <input name="phone" placeholder="Phone Number" class="input" required>

                <input name="address_line_1" placeholder="Address Line 1" class="input" required>
                <input name="address_line_2" placeholder="Address Line 2" class="input">

                <input name="city" placeholder="City" class="input" required>
                <input name="state" placeholder="State" class="input" required>

                <input name="postal_code" placeholder="Postal Code" class="input" required>
                <input name="country" placeholder="Country" class="input" required>

            </div>

            <label class="flex items-center gap-2 mt-2">
                <input type="checkbox" name="is_default">
                <span>Set as Default</span>
            </label>

            <div class="flex justify-end gap-2 mt-4">
                <button type="button" onclick="document.getElementById('addAddressModal').classList.add('hidden')"
                    class="px-4 py-2 bg-gray-200 rounded">Cancel</button>

                <button class="px-4 py-2 bg-orange-600 text-white rounded">Save</button>
            </div>

        </form>

    </div>
</div>



<!-- ========================================================
     EDIT ADDRESS MODAL
========================================================= -->
<div id="editAddressModal"
     class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">

    <div class="bg-white p-5 rounded-xl w-full max-w-lg shadow">

        <h2 class="text-lg font-semibold mb-3">Edit Address</h2>

        <form id="editAddressForm" method="POST">
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

                <input id="e_full_name" name="full_name" class="input" required>
                <input id="e_phone" name="phone" class="input" required>

                <input id="e_address_line_1" name="address_line_1" class="input" required>
                <input id="e_address_line_2" name="address_line_2" class="input">

                <input id="e_city" name="city" class="input" required>
                <input id="e_state" name="state" class="input" required>

                <input id="e_postal_code" name="postal_code" class="input" required>
                <input id="e_country" name="country" class="input" required>

            </div>

            <label class="flex items-center gap-2 mt-2">
                <input id="e_is_default" type="checkbox" name="is_default">
                <span>Set as Default</span>
            </label>

            <div class="flex justify-end gap-2 mt-4">
                <button type="button" onclick="document.getElementById('editAddressModal').classList.add('hidden')"
                    class="px-4 py-2 bg-gray-200 rounded">Cancel</button>

                <button class="px-4 py-2 bg-orange-600 text-white rounded">Update</button>
            </div>

        </form>

    </div>
</div>



<!-- ========================================================
     JS (TABS + EDIT MODAL)
========================================================= -->
<script>
    // Switch Tabs
    const tabs = document.querySelectorAll(".tab-btn");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach(btn => {
        btn.addEventListener("click", () => {
            tabs.forEach(b => b.classList.remove("active-tab"));
            btn.classList.add("active-tab");

            contents.forEach(c => c.classList.add("hidden"));
            document.getElementById(btn.dataset.tab).classList.remove("hidden");
        });
    });

    // Edit Address Modal Fill
    function openEditAddressModal(id, name, phone, line1, line2, city, state, postal, country, isDefault) {

        document.getElementById('editAddressForm').action = `/account/address/edit/${id}/`;

        document.getElementById('e_full_name').value = name;
        document.getElementById('e_phone').value = phone;

        document.getElementById('e_address_line_1').value = line1;
        document.getElementById('e_address_line_2').value = line2;

        document.getElementById('e_city').value = city;
        document.getElementById('e_state').value = state;
        document.getElementById('e_postal_code').value = postal;
        document.getElementById('e_country').value = country;

        document.getElementById('e_is_default').checked = isDefault;

        document.getElementById('editAddressModal').classList.remove('hidden');
    }
</script>


<!-- Tailwind helper (small inputs) -->
<style>
    .input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        outline: none;
    }
    .input:focus {
        border-color: #fb923c;
        box-shadow: 0 0 4px #fcd9b6;
    }

    .tab-btn {
        padding: 8px 14px;
        border-bottom-width: 2px;
        font-weight: 500;
        color: gray;
        cursor: pointer;
    }
    .active-tab {
        color: #fb923c;
        border-color: #fb923c;
        font-weight: 600;
    }
</style>

{% endblock %}
